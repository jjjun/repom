"""Redis Docker ç’°å¢ƒç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä½¿ç”¨æ–¹æ³•:
    poetry run redis_generate   # docker-compose.yml ã‚’ç”Ÿæˆ
    poetry run redis_start      # Redis ã‚’èµ·å‹•
    poetry run redis_stop       # Redis ã‚’åœæ­¢
    poetry run redis_remove     # Redis ã‚’å‰Šé™¤
"""

import subprocess
import sys
from pathlib import Path

from repom.config import config
from repom._.docker_compose import DockerComposeGenerator, DockerService, DockerVolume
from repom._ import docker_manager as dm


def get_compose_dir() -> Path:
    """docker-compose.yml ã®ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—

    Returns:
        config.data_path ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    """
    compose_dir = Path(config.data_path)
    compose_dir.mkdir(parents=True, exist_ok=True)
    return compose_dir


class RedisManager(dm.DockerManager):
    """Redis ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ï¼ˆDocker Manager åŸºç›¤ã‚’ä½¿ç”¨ï¼‰

    docker-compose ã«ã‚ˆã‚‹ start/stop/remove ã¯ DockerManager åŸºç›¤ã‚¯ãƒ©ã‚¹ã‹ã‚‰ç¶™æ‰¿
    """

    def __init__(self):
        self.config = config

    def get_container_name(self) -> str:
        """Redis ã‚³ãƒ³ãƒ†ãƒŠåã‚’è¿”ã™"""
        return self.config.redis.container.get_container_name()

    def get_compose_file_path(self) -> Path:
        """compose ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¿”ã™"""
        compose_file = get_compose_dir() / "docker-compose.generated.yml"
        if not compose_file.exists():
            raise FileNotFoundError(
                f"Compose file not found: {compose_file}\n"
                f"Hint: Run 'poetry run redis_generate' first"
            )
        return compose_file

    def wait_for_service(self, max_retries: int = 30) -> None:
        """Redis ã®èµ·å‹•ã‚’å¾…æ©Ÿï¼ˆredis-cli ping ã«ã‚ˆã‚‹ç¢ºèªï¼‰"""
        container_name = self.get_container_name()

        def check_redis_ready():
            try:
                result = subprocess.run(
                    ["docker", "exec", container_name, "redis-cli", "ping"],
                    capture_output=True,
                    text=True,
                    timeout=2,
                    check=False
                )
                return result.returncode == 0 and "PONG" in result.stdout
            except Exception:
                return False

        dm.DockerCommandExecutor.wait_for_readiness(
            check_redis_ready,
            max_retries=max_retries,
            service_name="Redis"
        )

    def print_connection_info(self) -> None:
        """Redis æ¥ç¶šæƒ…å ±ã‚’è¡¨ç¤º"""
        print()
        print("ğŸ“¦ Redis Connection:")
        print(f"  Host: localhost")
        print(f"  Port: {self.config.redis.port}")
        print(f"  CLI: redis-cli -p {self.config.redis.port}")
        print()


def get_init_dir() -> Path:
    """Redis åˆæœŸåŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—

    Returns:
        config.data_path/redis_init/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    """
    compose_dir = get_compose_dir()
    init_dir = compose_dir / "redis_init"
    init_dir.mkdir(parents=True, exist_ok=True)
    return init_dir


def generate_redis_conf() -> str:
    """Redis è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ

    åŸºæœ¬çš„ãª redis.conf ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹
    """
    return """# Redis Configuration (auto-generated by repom)
# 
# Do not edit manually - modify config in repom/config.py instead

# Database
databases 16

# Persistence
appendonly yes
appendfsync everysec

# Snapshots
save 900 1
save 300 10
save 60 10000

# Memory
maxmemory 256mb
maxmemory-policy allkeys-lru

# Logging
loglevel notice
"""


def generate_docker_compose() -> DockerComposeGenerator:
    """config ã‹ã‚‰ docker-compose.yml ç”Ÿæˆå™¨ã‚’ä½œæˆ"""
    redis_port = config.redis.port
    container_name = config.redis.container.get_container_name()
    volume_name = config.redis.container.get_volume_name()
    image = config.redis.container.image

    # init ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
    init_dir = get_init_dir()

    # Redis ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©
    redis_service = DockerService(
        name="redis",
        image=image,
        container_name=container_name,
        ports=[f"{redis_port}:6379"],
        volumes=[
            f"{volume_name}:/data",
            f"{init_dir.absolute()}/redis.conf:/usr/local/etc/redis/redis.conf",
        ],
        command="redis-server /usr/local/etc/redis/redis.conf",
        healthcheck={
            "test": '["CMD", "redis-cli", "ping"]',
            "interval": "5s",
            "timeout": "5s",
            "retries": 5,
        }
    )

    # Docker Volume ã‚’å®šç¾©
    data_volume = DockerVolume(name=volume_name)

    # ç”Ÿæˆå™¨ã‚’ä½œæˆ
    generator = DockerComposeGenerator()
    generator.add_service(redis_service)
    generator.add_volume(data_volume)

    return generator


def generate():
    """docker-compose.yml ã¨ Redis è¨­å®šã‚’ç”Ÿæˆï¼ˆã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ï¼‰"""
    # Redis è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
    init_dir = get_init_dir()
    redis_conf = generate_redis_conf()
    (init_dir / "redis.conf").write_text(redis_conf, encoding="utf-8")

    # docker-compose.yml ã‚’ç”Ÿæˆ
    generator = generate_docker_compose()
    compose_dir = get_compose_dir()
    output_path = compose_dir / "docker-compose.generated.yml"
    generator.write_to_file(output_path)

    print(f"âœ… Generated: {output_path}")
    print(f"   Config: {init_dir / 'redis.conf'}")
    print(f"\nğŸ“¦ Redis Service:")
    print(f"   Container: {config.redis.container.get_container_name()}")
    print(f"   Port: {config.redis.port}")
    print(f"   Volume: {config.redis.container.get_volume_name()}")


def start():
    """Redis ã‚’èµ·å‹•"""
    # docker-compose.yml ã‚’ç”Ÿæˆ
    generate()

    manager = RedisManager()

    try:
        manager.start()
        manager.print_connection_info()
    except TimeoutError as e:
        print(f"âŒ {e}")
        print(f"Check logs: docker logs repom_redis")
        sys.exit(1)


def stop():
    """Redis ã‚’åœæ­¢ï¼ˆã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ã®ã¿ã€å‰Šé™¤ã¯ã—ãªã„ï¼‰"""
    manager = RedisManager()

    try:
        manager.stop()
    except SystemExit:
        raise


def remove():
    """Redis ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ï¼ˆå®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼‰"""
    manager = RedisManager()

    try:
        manager.remove()
    except SystemExit:
        raise


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python manage.py [generate|start|stop|remove]")
        sys.exit(1)

    command = sys.argv[1]
    if command == "generate":
        generate()
    elif command == "start":
        start()
    elif command == "stop":
        stop()
    elif command == "remove":
        remove()
    else:
        print(f"Unknown command: {command}")
        print("Usage: python manage.py [generate|start|stop|remove]")
        sys.exit(1)
