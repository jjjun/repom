# Issue #022: isolated_mapper_registry ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®è¨­è¨ˆæ”¹å–„

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“ èª¿æŸ»å¾…æ©Ÿä¸­  
**ä½œæˆæ—¥**: 2026-01-28  
**å„ªå…ˆåº¦**: ä½  
**è¤‡é›‘åº¦**: é«˜

## æ¦‚è¦

`isolated_mapper_registry` ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¯ã€repom ã®ãƒ¢ãƒ‡ãƒ«ã®ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹è¨­è¨ˆã®ãŸã‚ã€behavior_tests ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹å ´åˆã«æ­£ã—ãå‹•ä½œã—ãªã„å•é¡Œã€‚

**ç¾çŠ¶**: ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã§ã®ã¿å‹•ä½œã€Issue #021 ã§å›é¿ç­–ã‚’å®Ÿè£…æ¸ˆã¿  
**ææ¡ˆ**: ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®è¨­è¨ˆæ”¹å–„ã¾ãŸã¯ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ¤œè¨

## å•é¡Œã®èª¬æ˜

### ç¾åœ¨ã®å‹•ä½œ

**isolated_mapper_registry ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. clear_mappers() ã§ãƒãƒƒãƒ‘ãƒ¼ã‚’ã‚¯ãƒªã‚¢
2. behavior_test_modules ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†ãƒ­ãƒ¼ãƒ‰
3. `load_models()` ã§ repom ã®ãƒ¢ãƒ‡ãƒ«ã‚’å†ãƒ­ãƒ¼ãƒ‰ï¼ˆé‡è¦ï¼‰
4. configure_mappers() ã§ãƒãƒƒãƒ‘ãƒ¼ã‚’å†æ§‹ç¯‰
5. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆ

### å•é¡Œç‚¹

**load_models() ã¯ repom ã®ãƒ¢ãƒ‡ãƒ«ã®ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**:

```python
# repom/utility.py
def load_models(context: Optional[str] = None) -> None:
    if config.model_locations:
        auto_import_models_from_list(
            package_names=config.model_locations,  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ ['repom.models']
            ...
        )
```

**çµæœ**:
- behavior_tests ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: test_date_type_comparison ã® TaskDateModelï¼‰ãŒæ¤œå‡ºã•ã‚Œãªã„
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†ãƒ­ãƒ¼ãƒ‰å¾Œã€ãƒãƒƒãƒ‘ãƒ¼ãŒå†æ§‹ç¯‰ã•ã‚Œãªã„
- ãƒ†ã‚¹ãƒˆãŒ `UnmappedInstanceError` ã§å¤±æ•—

### ç¾åœ¨ã®ä½¿ç”¨çŠ¶æ³

#### âœ… æ­£å¸¸å‹•ä½œã™ã‚‹ã‚±ãƒ¼ã‚¹

**test_type_checking_detailed.py**, **test_type_checking_import_order.py**
- ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©
- isolated_mapper_registry ãŒæ­£å¸¸ã«æ©Ÿèƒ½

```python
def test_sqlalchemy_relationship_lazy_resolution(isolated_mapper_registry):
    # ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ãƒ¢ãƒ‡ãƒ«å®šç¾©
    from tests.fixtures.type_checking import a_parent, z_child
    # ...
```

#### âŒ å‹•ä½œã—ãªã„ã‚±ãƒ¼ã‚¹ï¼ˆIssue #021 ã§ç™ºè¦‹ï¼‰

**test_date_type_comparison.py**ï¼ˆIssue #021 è§£æ±ºå‰ï¼‰
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©
- isolated_mapper_registry ãŒå‹•ä½œã—ãªã„

```python
# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«
class TaskDateModel(TaskModel):
    __tablename__ = 'task_date'
    # ...

def test_compare_save_behavior(isolated_mapper_registry, db_test):
    # TaskDateModel ã‚’ä½¿ç”¨ï¼ˆUnmappedInstanceErrorï¼‰
```

**Issue #021 ã®è§£æ±ºç­–**: ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«å†å®šç¾©ï¼ˆå›é¿ç­–ï¼‰

---

## æ ¹æœ¬åŸå› 

### 1. load_models() ã®åˆ¶é™

`load_models()` ã¯ `config.model_locations` ã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ãŒã€ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `['repom.models']` ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã€‚

### 2. behavior_test_modules ã®å†ãƒ­ãƒ¼ãƒ‰

conftest.py ã§ã¯ `behavior_test_modules` ãƒªã‚¹ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ãŒ:

```python
behavior_test_modules = [
    'tests.behavior_tests.test_date_type_comparison',  # å†ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
    'tests.behavior_tests.test_migration_no_id',
]
```

å†ãƒ­ãƒ¼ãƒ‰å¾Œã€`load_models()` ã§ã¯æ¤œå‡ºã•ã‚Œãªã„ãŸã‚ã€ãƒãƒƒãƒ‘ãƒ¼ãŒå†æ§‹ç¯‰ã•ã‚Œã¾ã›ã‚“ã€‚

### 3. è¨­è¨ˆä¸Šã®åˆ¶ç´„

isolated_mapper_registry ã¯ä»¥ä¸‹ã‚’æƒ³å®š:
- ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ãƒ¢ãƒ‡ãƒ«å®šç¾©
- repom ã®ãƒ¢ãƒ‡ãƒ«ã®ã¿ã‚’ä½¿ç”¨

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã¯æƒ³å®šå¤–ã€‚

---

## ææ¡ˆã•ã‚Œã‚‹è§£æ±ºç­–

### æ¡ˆ1: load_models() ã®æ‹¡å¼µï¼ˆæ¨å¥¨åº¦ï¼šä¸­ï¼‰

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
- behavior_test_modules ã®ãƒ¢ãƒ‡ãƒ«ã‚‚æ¤œå‡ºã§ãã‚‹ã‚ˆã†ã« load_models() ã‚’æ‹¡å¼µ
- ã¾ãŸã¯ã€isolated_mapper_registry å†…ã§åˆ¥ã®ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã«å¯¾å¿œ
- âœ… æ—¢å­˜ã®è¨­è¨ˆã‚’æ´»ã‹ã›ã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ load_models() ã®è¤‡é›‘æ€§å¢—åŠ 
- âŒ behavior_tests ã®æ§‹é€ ã«ä¾å­˜

**å®Ÿè£…ä¾‹**:
```python
# isolated_mapper_registry å†…
for module_name in behavior_test_modules:
    module = sys.modules[module_name]
    # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ˜ç¤ºçš„ã«æ¤œå‡ºãƒ»ç™»éŒ²
    for attr_name in dir(module):
        attr = getattr(module, attr_name)
        if isinstance(attr, type) and issubclass(attr, Base):
            # ãƒãƒƒãƒ‘ãƒ¼ã‚’å†æ§‹ç¯‰
            configure_mappers()
```

### æ¡ˆ2: ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ›´ï¼ˆæ¨å¥¨åº¦ï¼šä½ï¼‰

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
- isolated_mapper_registry ã‚’ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ãƒ¢ãƒ‡ãƒ«å°‚ç”¨ã¨ã™ã‚‹
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã¯åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆIssue #021 ã®è§£æ±ºç­–ï¼‰ã‚’ä½¿ç”¨

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
- âœ… æ—¢å­˜ã®å‹•ä½œã‚’ç¶­æŒ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã«ã¯éå¯¾å¿œï¼ˆç¾çŠ¶ç¶­æŒï¼‰
- âŒ åˆ¶ç´„ãŒæ˜ç¤ºã•ã‚Œã¦ã„ãªã„

### æ¡ˆ3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ã®ã¿ï¼ˆæ¨å¥¨åº¦ï¼šé«˜ï¼‰

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
- isolated_mapper_registry ã®åˆ¶ç´„ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ Issue #021 ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¨å¥¨

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… å®Ÿè£…ä¸è¦
- âœ… å›é¿ç­–ãŒæ—¢ã«å­˜åœ¨
- âœ… ã‚·ãƒ³ãƒ—ãƒ«

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ æ ¹æœ¬çš„ãªè§£æ±ºã§ã¯ãªã„

**å®Ÿè£…ä¾‹**:
```python
def isolated_mapper_registry(db_test):
    """ä¸€æ™‚çš„ãªãƒ¢ãƒ‡ãƒ«å®šç¾©ç”¨ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
    
    ã€é‡è¦ãªåˆ¶ç´„ã€‘:
    - ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¦ãã ã•ã„
    - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹å ´åˆã¯å‹•ä½œã—ã¾ã›ã‚“
    - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€å„ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§
      ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’å†å®šç¾©ã—ã¦ãã ã•ã„ï¼ˆtest_unique_key_handling.py å‚ç…§ï¼‰
    
    ä½¿ç”¨ä¾‹:
        def test_temporary_model(isolated_mapper_registry, db_test):
            from repom.models.base_model import BaseModel
            
            class TempModel(BaseModel):
                __tablename__ = 'temp_table'
                name: Mapped[str] = mapped_column(String(100))
            
            # ...
    """
```

---

## å½±éŸ¿ç¯„å›²

### ä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«

- **tests/conftest.py** - isolated_mapper_registry ã®å®Ÿè£…
- **docs/guides/testing/isolated_mapper_fixture.md** - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

### å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ†ã‚¹ãƒˆ

- âœ… test_type_checking_detailed.py - å½±éŸ¿ãªã—ï¼ˆæ—¢ã«æ­£å¸¸å‹•ä½œï¼‰
- âœ… test_type_checking_import_order.py - å½±éŸ¿ãªã—ï¼ˆæ—¢ã«æ­£å¸¸å‹•ä½œï¼‰
- âœ… test_date_type_comparison.py - å½±éŸ¿ãªã—ï¼ˆIssue #021 ã§å›é¿ç­–å®Ÿè£…æ¸ˆã¿ï¼‰

---

## å®Ÿè£…è¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º1: èª¿æŸ»ï¼ˆå„ªå…ˆï¼‰

- [ ] isolated_mapper_registry ã®ä½¿ç”¨çŠ¶æ³ã‚’å…¨ãƒ†ã‚¹ãƒˆã§ç¢ºèª
- [ ] å®Ÿéš›ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã‚’æ¸¬å®š

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

- [ ] conftest.py ã® isolated_mapper_registry ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
- [ ] docs/guides/testing/isolated_mapper_fixture.md ã‚’æ›´æ–°
- [ ] åˆ¶ç´„ã¨å›é¿ç­–ã‚’æ˜è¨˜

### ãƒ•ã‚§ãƒ¼ã‚º3: å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

æ¡ˆ1ã¾ãŸã¯æ¡ˆ2ã‚’é¸æŠã—ã¦å®Ÿè£…ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **Issue #021** - ãƒ†ã‚¹ãƒˆé–“ã®ãƒãƒƒãƒ‘ãƒ¼ã‚¯ãƒªã‚¢å¹²æ¸‰å•é¡Œï¼ˆå›é¿ç­–å®Ÿè£…æ¸ˆã¿ï¼‰
- **test_unique_key_handling.py** - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«å†å®šç¾©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ä¾‹
- **tests/conftest.py** - isolated_mapper_registry ã®å®Ÿè£…
- **docs/guides/testing/isolated_mapper_fixture.md** - ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚¬ã‚¤ãƒ‰

---

## å‚™è€ƒ

### å„ªå…ˆåº¦ãŒä½ã„ç†ç”±

1. **å›é¿ç­–ãŒå­˜åœ¨**: Issue #021 ã§å®Ÿè¨¼æ¸ˆã¿ã®è§£æ±ºç­–ãŒã‚ã‚‹
2. **å®Ÿéš›ã®å½±éŸ¿ãŒé™å®šçš„**: ã»ã¨ã‚“ã©ã®ãƒ†ã‚¹ãƒˆã§å•é¡Œãªãå‹•ä½œ
3. **è¨­è¨ˆå¤‰æ›´ã®ãƒªã‚¹ã‚¯**: æ”¹å–„ã«ã‚ˆã‚‹å‰¯ä½œç”¨ã®å¯èƒ½æ€§

### å°†æ¥çš„ãªæ”¹å–„

- behavior_tests ã®ãƒ¢ãƒ‡ãƒ«æ§‹é€ ã‚’æ¨™æº–åŒ–
- ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚’ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦æ¨å¥¨
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’æ®µéšçš„ã«å‰Šæ¸›

---

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ã‚’å„ªå…ˆï¼ˆæ¡ˆ3ï¼‰
2. å¿…è¦ã«å¿œã˜ã¦æ¡ˆ1ã®å®Ÿè£…ã‚’æ¤œè¨
3. æ–°ã—ã„ãƒ†ã‚¹ãƒˆã§ã¯å¿…ãšãƒ†ã‚¹ãƒˆé–¢æ•°å†…ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚’ä½¿ç”¨
