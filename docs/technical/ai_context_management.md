# AI コンテキスト管理ガイド

**作成日**: 2025-11-15  
**対象**: repom プロジェクトでの AI エージェント活用

## 📚 このドキュメントについて

このドキュメントは、repom プロジェクトにおける AI エージェント（特に GitHub Copilot + Claude 3.5 Sonnet）とのやり取りで得られた知見を記録したものです。AIエージェントのコンテキスト管理、トークン消費、最適化の仕組みについて説明します。

---

## 目次

1. [Claude 3.5 Sonnet の基本スペック](#claude-35-sonnet-の基本スペック)
2. [コンテキストウィンドウとトークン消費](#コンテキストウィンドウとトークン消費)
3. [ドキュメント構造の最適化](#ドキュメント構造の最適化)
4. [AI エージェントの読み込み優先度](#ai-エージェントの読み込み優先度)
5. [実運用でのコンテキスト管理](#実運用でのコンテキスト管理)
6. [ベストプラクティス](#ベストプラクティス)

---

## Claude 3.5 Sonnet の基本スペック

### 技術仕様（2025年11月時点）

```
Claude 3.5 Sonnet (GitHub Copilot 経由)
├── コンテキストウィンドウ: 200,000トークン
├── 出力上限: 8,192トークン
└── 実効利用可能: 約191,000トークン（出力分を除く）
```

### トークン換算の目安

```
日本語:
  1文字 ≈ 2-3トークン
  1行（40文字） ≈ 80-120トークン
  100行 ≈ 8,000-12,000トークン

英語:
  1単語 ≈ 1-2トークン
  1行（80文字） ≈ 15-25トークン
  100行 ≈ 1,500-2,500トークン

マークダウン:
  1,000行 ≈ 20,000-30,000トークン（日本語）
  1,000行 ≈ 10,000-15,000トークン（英語）
```

### repom プロジェクトのドキュメントサイズ

```
README.md（現在）: 1,388行
  → 約35,000-40,000トークン（日本語多め）
  → コンテキストの約18-20%

README.md（簡略化後）: 900行
  → 約22,000-25,000トークン
  → コンテキストの約12%

docs/guides/base_model_auto_guide.md: 約800行
  → 約20,000トークン
  → コンテキストの約10%

docs/guides/repository_and_utilities_guide.md: 約600行
  → 約15,000トークン
  → コンテキストの約8%
```

---

## コンテキストウィンドウとトークン消費

### コンテキストの構成要素

```
[コンテキストの内訳]

1. システムプロンプト: 約5,000トークン
   └── .github/copilot-instructions.md
   └── AGENTS.md
   └── 内部指示

2. 会話履歴: 可変（10,000-50,000トークン）
   └── 過去のやり取り
   └── 要約された古い会話

3. ワークスペースコンテキスト: 可変（20,000-80,000トークン）
   ├── README.md（必ず読み込み）
   ├── 開いているファイル（自動）
   ├── semantic_search結果
   ├── grep_search結果
   └── read_file結果

4. 出力バッファ: 8,192トークン（予約）

───────────────────────────────────────
合計: 43,192 - 143,192トークン（状況による）
残り: 56,808 - 156,808トークン
```

### 実際のコンテキスト消費例

#### シナリオA: 新機能の実装

```
[コンテキスト内容]
1. README.md: 25,000トークン（12%）
2. 編集中のファイル: 2,000トークン（1%）
3. 関連ファイル3つ: 4,000トークン（2%）
4. 会話履歴: 15,000トークン（8%）
5. システムプロンプト: 5,000トークン（2.5%）

合計: 51,000トークン（25%）
残り: 140,000トークン（70%）
```

#### シナリオB: バグ修正（複数ファイル調査）

```
[コンテキスト内容]
1. README.md: 25,000トークン（12%）
2. 編集中のファイル: 2,000トークン（1%）
3. semantic_search結果（10ファイル）: 15,000トークン（8%）
4. grep_search結果: 5,000トークン（2.5%）
5. 会話履歴: 25,000トークン（12%）
6. システムプロンプト: 5,000トークン（2.5%）

合計: 77,000トークン（38%）
残り: 114,000トークン（57%）
```

#### シナリオC: ドキュメント参照作業

```
[コンテキスト内容]
1. README.md: 25,000トークン（12%）
2. base_model_auto_guide.md: 20,000トークン（10%）
3. repository_and_utilities_guide.md: 15,000トークン（8%）
4. 作業ファイル: 10,000トークン（5%）
5. 会話履歴: 20,000トークン（10%）
6. システムプロンプト: 5,000トークン（2.5%）

合計: 95,000トークン（47%）
残り: 96,000トークン（48%）
```

### コンテキスト圧迫が問題になるケース

```
[危険ゾーン: 85%以上]
├── 巨大なファイルを複数読み込み
├── 会話が100ターン以上継続
├── semantic_searchで50件以上ヒット
└── → この場合でも自動要約が働く
```

---

## ドキュメント構造の最適化

### なぜ README.md を分割したのか

#### 当初の懸念

```
統合版 README.md:
  現在: 1,388行（35,000トークン）
  + base_model_auto_guide.md: 541行（13,000トークン）
  + auto_import_models_guide.md: 300行（7,500トークン）
  ─────────────────────────────────────
  合計: 2,229行（55,500トークン）= 28% のコンテキスト消費
```

**懸念点**:
1. 出力制限（8,192トークン）を超えてしまう
2. README.md の作成が複数ステップ必要
3. 人間が読むには長すぎる

#### 解決策: 機能別に分割

```
最終構成:
  README.md: 900行（22,000トークン）= 11%
  docs/guides/base_model_auto_guide.md: 800行（20,000トークン）= 10%
  docs/guides/repository_and_utilities_guide.md: 600行（15,000トークン）= 8%
  ─────────────────────────────────────
  合計: 2,300行（57,000トークン）
  
  同時読み込み時: 29% のコンテキスト消費
  → 余裕あり（71%残る）
```

**メリット**:
1. ✅ 各ファイルを個別に作成可能（出力制限回避）
2. ✅ 必要なガイドのみ参照可能（効率的）
3. ✅ 人間が指示を出しやすい（1ファイルパスで済む）
4. ✅ コンテキスト管理が最適化される

### docs 配下のファイルは読まれるのか？

#### 実際の検証結果

| ファイル配置 | AI エージェントが読む確率 | 理由 |
|--------------|--------------------------|------|
| `README.md` | **95%** | semantic_search のトップヒット |
| `.github/copilot-instructions.md` | **90%** | GitHub Copilot 専用 |
| `AGENTS.md` | **85%** | プロジェクトルート |
| `docs/*.md` | **30%** | 明示的リンクがあれば |
| `docs/technical/*.md` | **10%** | ほぼ無視される |

#### 対策: copilot-instructions.md に明記

```markdown
## 📚 重要なドキュメントファイル

### Feature-Specific Guides (機能実装時に参照)

#### BaseModelAuto & スキーマ自動生成
**ファイル**: `docs/guides/base_model_auto_guide.md`

**使用タイミング**:
- SQLAlchemy モデルから Pydantic スキーマを生成する場合
- FastAPI のエンドポイントで response_model を定義する場合
```

**効果**:
- copilot-instructions.md に明記 → **85%** の確率で読まれる
- ユーザーが明示的に指示 → **100%** 確実に読まれる

---

## AI エージェントの読み込み優先度

### 自動読み込みファイル

```
[優先度: 高] 常にコンテキストに含まれる
├── 現在編集中のファイル（100%）
├── README.md（90%）
├── AGENTS.md（85%）
└── .github/copilot-instructions.md（80%）

[優先度: 中] 必要に応じて読み込み
├── semantic_search 結果（タスク依存）
├── 関連ファイル（AI 判断）
└── テストファイル（実行時）

[優先度: 低] 明示的に指示されたら読み込み
├── docs/配下のファイル
└── 古いバージョンのファイル
```

### ユーザーの指示による読み込み

```
# パターン1: ファイルパスを明示
ユーザー: 「docs/guides/base_model_auto_guide.md を見て実装して」
AI: [base_model_auto_guide.md を読み込み] → 100%確実

# パターン2: 機能名のみ指定
ユーザー: 「BaseModelAuto を使ってスキーマ生成して」
AI: [copilot-instructions.md を確認]
    [base_model_auto_guide.md を見つける] → 85%

# パターン3: 指示なし
ユーザー: 「スキーマを追加して」
AI: [README.md のみ参照] → 30%（詳細が不足）
```

### 最適な指示の出し方

```
✅ Good: ファイルパスを明示
「docs/guides/base_model_auto_guide.md を参考にして、
 User モデルに FastAPI スキーマを追加してください」

✅ Good: 複数ガイドを参照
「docs/guides/base_model_auto_guide.md と
 docs/guides/repository_and_utilities_guide.md を見て、
 Task の CRUD エンドポイントと検索機能を実装してください」

❌ Bad: 指示が曖昧
「スキーマ生成機能を実装して」
→ AI は README.md しか見ない可能性あり
```

---

## 実運用でのコンテキスト管理

### 自動最適化の仕組み

GitHub Copilot + Claude は**動的にコンテキストを管理**します：

#### 1. 優先度ベースの読み込み

前述の「AI エージェントの読み込み優先度」を参照

#### 2. 会話履歴の要約

```
[会話が長くなると]
古い会話（50ターン前）
  ↓ 自動要約
"Issue #3のフェーズ1-5を完了。現在フェーズ6のドキュメント作成中"
  ↓ 圧縮
約500トークンに削減
```

#### 3. 不要なコンテキストの削除

```
[30分前に read_file したファイル]
→ 使われていない
→ 自動的に削除
```

### ソースコード読み込みの実際

#### Q: コーディング中にソースを読むとコンテキストは増える？
**A: はい、増えますが、賢く管理されます**

```python
# 例: base_repository.py を編集中

[コンテキストに自動追加されるもの]
1. base_repository.py の全内容（常時）: 約2,000トークン
2. 関連ファイル（AI判断で自動追加）:
   - repom/models/base_model.py: 約1,500トークン
   - repom/db.py: 約500トークン
3. README.md（必須）: 22,000トークン
4. 会話履歴: 20,000トークン

───────────────────────────
現在の消費: 約46,000トークン（23%）
残り: 145,000トークン（72%）
```

### ChatGPT Codex との使い分け

```
GitHub Copilot (Claude 3.5 Sonnet)
├── コンテキスト: 200,000トークン
├── 用途: 複雑なタスク、設計判断
└── README.md を常時読む

ChatGPT Codex
├── コンテキスト: 128,000トークン
├── 用途: 単純な実装タスク
└── README.md の読み込みは手動
```

**Claudeの方がコンテキストが大きい** = より安心

---

## ベストプラクティス

### 1. ドキュメントのサイズ管理

```
✅ 推奨: 1ファイル 500-1,000行（10,000-25,000トークン）
⚠️ 注意: 1ファイル 1,500行以上（35,000トークン超）
❌ 避ける: 1ファイル 2,500行以上（60,000トークン超）
```

**理由**:
- 出力制限（8,192トークン）を考慮
- 1回のツール呼び出しで作成可能
- 人間にも読みやすい

### 2. ガイドドキュメントの配置

```
✅ Good: 機能別に分割
docs/guides/
├── base_model_auto_guide.md       # スキーマ自動生成
└── repository_and_utilities_guide.md  # 基盤機能

✅ Good: トップレベルに重要ドキュメント
README.md
AGENTS.md
.github/copilot-instructions.md

❌ Bad: すべてを README.md に詰め込む
README.md (2,500行) → 出力制限で作成不可
```

### 3. AI への指示の出し方

```
✅ Good: 具体的なファイルパス
「docs/guides/base_model_auto_guide.md を見て実装して」

✅ Good: 複数ファイルを列挙
「README.md と docs/guides/base_model_auto_guide.md を参考に」

❌ Bad: 曖昧な指示
「ドキュメントを見て実装して」
→ AIはどのファイルを読めば良いか分からない
```

### 4. コンテキスト消費の監視

```
[日常的なコーディング]
README.md + 作業ファイル + 会話履歴
= 約40-50%（安全圏）

[複雑な調査タスク]
README.md + ガイド2つ + 検索結果 + 会話履歴
= 約60-70%（まだ余裕）

[警戒ゾーン: 80%超]
長時間の会話継続
→ 新しいチャットセッションを開始することを検討
```

### 5. プロジェクト固有の最適化

```
repom プロジェクトの場合:
  README.md: 900行（22,000トークン）= 11%
  + base_model_auto_guide.md: 800行（20,000トークン）= 10%
  + repository_and_utilities_guide.md: 600行（15,000トークン）= 8%
  ─────────────────────────────────────
  合計: 29%（同時参照時）
  
  余裕: 71%（十分な作業スペース）
```

---

## まとめ

### 重要なポイント

1. **Claude 3.5 Sonnet のコンテキスト: 200,000トークン**
   - 十分に大きい
   - 50-60%の消費でも快適に動作

2. **ドキュメントは機能別に分割**
   - 1ファイル 500-1,000行が理想
   - 出力制限（8,192トークン）を考慮

3. **AI への指示は具体的に**
   - ファイルパスを明示
   - 曖昧な指示は避ける

4. **copilot-instructions.md に重要ドキュメントを明記**
   - AI が自動的に参照する
   - ユーザーの指示の手間を削減

5. **コンテキスト消費は 70%以下を目安に**
   - 通常の作業: 40-50%
   - 複雑なタスク: 60-70%
   - 警戒ゾーン: 80%超

### 今後の展望

- より大きなコンテキストウィンドウ（Claude 3.5+）
- より賢いコンテキスト管理
- プロジェクト固有の最適化

---

**関連ドキュメント**:
- **BaseModelAuto ガイド**: [../guides/base_model_auto_guide.md](../guides/base_model_auto_guide.md)
- **Repository & Utilities ガイド**: [../guides/repository_and_utilities_guide.md](../guides/repository_and_utilities_guide.md)
- **GitHub Copilot 指示**: [../../.github/copilot-instructions.md](../../.github/copilot-instructions.md)

---

**作成者**: Claude 3.5 Sonnet (GitHub Copilot)  
**協力**: jjjun (repom maintainer)  
**最終更新**: 2025-11-15
